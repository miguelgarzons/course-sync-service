name: Deploy Django to Cloud Run

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

env:
  PROJECT_ID: pruebasclassroomsinu
  REGION: us-central1
  PYTHON_VERSION: '3.11'

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Check for syntax errors
      run: |
        python -m py_compile $(find . -name "*.py" -not -path "./venv/*" -not -path "./.venv/*")

    - name: Run Django checks
      run: python manage.py check --deploy

    - name: Run migrations check
      run: python manage.py makemigrations --check --dry-run

    - name: Run tests
      run: python manage.py test
      continue-on-error: false

    - name: Build Docker image (test)
      run: docker build -t test-image:latest .

  # ========================================
  # ðŸš€ DEPLOY TO DEVELOPMENT (develop branch)
  # ========================================
  deploy-develop:
    needs: build-and-test
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment:
      name: development
      url: https://django-api-dev-xxxxxxxxx-uc.a.run.app
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v1

    - name: Configure Docker
      run: gcloud auth configure-docker

    - name: Build Docker image
      run: |
        docker build -t gcr.io/${{ env.PROJECT_ID }}/django-api-dev:${{ github.sha }} \
                     -t gcr.io/${{ env.PROJECT_ID }}/django-api-dev:latest .

    - name: Push to Container Registry
      run: |
        docker push gcr.io/${{ env.PROJECT_ID }}/django-api-dev:${{ github.sha }}
        docker push gcr.io/${{ env.PROJECT_ID }}/django-api-dev:latest

    - name: Create .env file
      run: |
        echo "DJANGO_DEBUG=${{ vars.DJANGO_DEBUG }}" >> .env
        echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> .env
        echo "DJANGO_ALLOWED_HOSTS=${{ vars.DJANGO_ALLOWED_HOSTS }}" >> .env
        echo "CORS_ALLOWED_ORIGINS=${{ vars.CORS_ALLOWED_ORIGINS }}" >> .env
        echo "DJANGO_SUPERUSER_USERNAME=${{ vars.DJANGO_SUPERUSER_USERNAME }}" >> .env
        echo "DJANGO_SUPERUSER_EMAIL=${{ vars.DJANGO_SUPERUSER_EMAIL }}" >> .env
        echo "DJANGO_SUPERUSER_PASSWORD=${{ secrets.DJANGO_SUPERUSER_PASSWORD }}" >> .env
        echo "ENVIRONMENT=development" >> .env
        echo "GOOGLE_CLOUD_PROJECT=${{ env.PROJECT_ID }}" >> .env
        echo "GOOGLE_ACCESS_TOKEN=${{ vars.GOOGLE_ACCESS_TOKEN }}" >> .env
        echo "GOOGLE_REFRESH_TOKEN=${{ vars.GOOGLE_REFRESH_TOKEN }}" >> .env
        echo "GOOGLE_CLIENT_ID=${{ vars.GOOGLE_CLIENT_ID }}" >> .env
        echo "GOOGLE_CLIENT_SECRET=${{ vars.GOOGLE_CLIENT_SECRET }}" >> .env
        echo "GOOGLE_IMPERSONATE_ADMIN=${{ vars.GOOGLE_IMPERSONATE_ADMIN }}" >> .env

    - name: Deploy to Cloud Run (Development)
      run: |
        gcloud run deploy course-sync-service-dev \
          --image gcr.io/${{ env.PROJECT_ID }}/django-api-dev:${{ github.sha }} \
          --region ${{ env.REGION }} \
          --platform managed \
          --allow-unauthenticated \
          --port 8000 \
          --env-vars-file .env \
          --max-instances=2 \
          --memory=512Mi

  # ========================================
  # ðŸš€ DEPLOY TO PRODUCTION (main branch)
  # ========================================
  deploy-production:
    needs: build-and-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://django-api-prod-xxxxxxxxx-uc.a.run.app 
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v1

    - name: Configure Docker
      run: gcloud auth configure-docker

    - name: Build Docker image
      run: |
        docker build -t gcr.io/${{ env.PROJECT_ID }}/django-api-prod:${{ github.sha }} \
                     -t gcr.io/${{ env.PROJECT_ID }}/django-api-prod:latest .

    - name: Push to Container Registry
      run: |
        docker push gcr.io/${{ env.PROJECT_ID }}/django-api-prod:${{ github.sha }}
        docker push gcr.io/${{ env.PROJECT_ID }}/django-api-prod:latest

    - name: Create .env file
      run: |
        echo "DJANGO_DEBUG=${{ vars.DJANGO_DEBUG_PROD }}" >> .env
        echo "SECRET_KEY=${{ secrets.SECRET_KEY_PROD }}" >> .env
        echo "DJANGO_ALLOWED_HOSTS=${{ vars.DJANGO_ALLOWED_HOSTS_PROD }}" >> .env
        echo "CORS_ALLOWED_ORIGINS=${{ vars.CORS_ALLOWED_ORIGINS_PROD }}" >> .env
        echo "DJANGO_SUPERUSER_USERNAME=${{ vars.DJANGO_SUPERUSER_USERNAME_PROD }}" >> .env
        echo "DJANGO_SUPERUSER_EMAIL=${{ vars.DJANGO_SUPERUSER_EMAIL_PROD }}" >> .env
        echo "DJANGO_SUPERUSER_PASSWORD=${{ secrets.DJANGO_SUPERUSER_PASSWORD_PROD }}" >> .env
        echo "ENVIRONMENT=production" >> .env
        echo "GOOGLE_CLOUD_PROJECT=${{ env.PROJECT_ID }}" >> .env

    - name: Deploy to Cloud Run (Production)
      run: |
        gcloud run deploy course-sync-service-prod \
          --image gcr.io/${{ env.PROJECT_ID }}/django-api-prod:${{ github.sha }} \
          --region ${{ env.REGION }} \
          --platform managed \
          --allow-unauthenticated \
          --port 8000 \
          --env-vars-file .env \
          --max-instances=3 \
          --memory=512Mi
